<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace = "post">
	<!-- 게시글 조회 -->
	<select id = "detailBoard" resultType = "post" parameterType = "map">
		SELECT PROFILEFILE, GROUPNICKNAME, POSTKEY, POSTTITLE, POSTCONTENT, POSTDATE, USERKEY, POSTREADCOUNT, GROUPKEY, POSTLIKE, REPLYCOUNT
		FROM GGROUPMEMBER JOIN (SELECT POSTKEY, POSTTITLE, POSTCONTENT, POSTDATE, USERKEY, POSTREADCOUNT, POSTLIKE, REPLYCOUNT
								FROM (	SELECT POSTKEY, POSTTITLE, POSTCONTENT, TO_CHAR(POSTDATE, 'YYYY-MM-DD') POSTDATE, USERKEY, POSTREADCOUNT, POSTLIKE
										FROM POST LEFT JOIN (	SELECT COUNT(POSTKEY) POSTLIKE, POSTKEY
																FROM POSTLIKE
																GROUP BY POSTKEY
																HAVING POSTKEY = #{postkey})			
								USING (POSTKEY)
								WHERE POSTKEY = #{postkey}) LEFT JOIN (	SELECT POSTKEY, COUNT(POSTKEY) REPLYCOUNT 
																		FROM GCOMMENT
																		GROUP BY POSTKEY
																		HAVING POSTKEY = #{postkey})		
								USING (POSTKEY))
		USING (USERKEY)
		WHERE GROUPKEY = #{groupkey}
	</select>
	
	<!-- 게시글 조회수 증가 -->
	<update id = "updateReadCount">
		UPDATE POST
		SET POSTREADCOUNT = POSTREADCOUNT + 1
		WHERE POSTKEY = #{POSTKEY}
	</update>
	
	<!-- 해당 모임에서 작성한 글 -->
	<select id = "wroteInGroup" resultType = "post" parameterType = "map">
		SELECT POSTKEY, GROUPKEY, POSTTITLE, POSTREADCOUNT, TO_CHAR(POSTDATE, 'YYYY-MM-DD') AS POSTDATE
		FROM POST
		WHERE USERKEY = #{userKey} AND GROUPKEY = #{groupKey}
		ORDER BY POSTDATE DESC
	</select>
	
	<!-- 유저가 댓글 단 글 -->
	<select id = "postByCommented" resultType = "post" parameterType = "map">
		SELECT USERKEY, POSTKEY, COMMENTCONTENT, GROUPKEY, REPLYCOUNT, POSTTITLE, TO_CHAR(COMMENTDATE, 'YYYY-MM-DD') COMMENTDATE, POSTREADCOUNT 
		FROM GCOMMENT LEFT JOIN (SELECT POSTKEY, POSTTITLE, REPLYCOUNT, POSTREADCOUNT
								 FROM POST LEFT JOIN (SELECT POSTKEY, COUNT(POSTKEY) REPLYCOUNT
							 						  FROM GCOMMENT
							 						  GROUP BY POSTKEY)
							 	 USING (POSTKEY)) 
		USING(POSTKEY)					 						  
		WHERE USERKEY = #{userKey} AND GROUPKEY = #{groupKey}							
	</select>
	
</mapper>