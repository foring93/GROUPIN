<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace = "group">
	<!-- 가입한 모임 보기 -->
	<select id = "userInGroup" resultType = "group">
		SELECT GROUPKEY, GROUPNAME, GROUPDFILE, TO_CHAR(GROUPDATE, 'YYYY-MM-DD') AS GROUPDATE, MEMBERCOUNT
		FROM GGROUP NATURAL JOIN ( 	SELECT GROUPKEY, COUNT(GROUPKEY) AS MEMBERCOUNT
									FROM GGROUPMEMBER
									GROUP BY GROUPKEY
									HAVING GROUPKEY IN (SELECT GROUPKEY 
														FROM GGROUPMEMBER
														WHERE USERKEY = #{USERKEY})) 
		ORDER BY GROUPDATE DESC
	</select>
	
	<!-- 모임의 가입 양식 가져오기 -->
	<select id = "getJoinSample" resultType = "joinQuest">
		SELECT * FROM JOINQUEST WHERE GROUPKEY = #{GROUPKEY}
	</select>
	
	<!-- 가입하기 -->
	<insert id = "joinGroup" parameterType = "groupmember">
		INSERT INTO GGROUPMEMBER
		VALUES(#{groupKey}, #{userKey}, #{groupNickname}, -1, #{profileFile}, #{profileOrigin})
	</insert>
	
	<!-- 가입양식 작성 -->
	<insert id = "setJoinSample" parameterType = "joinAnswer">
		INSERT INTO JOINANSWER
		VALUES(#{groupKey}, #{userKey}, #{answer1}, #{answer2}, #{answer3}, #{answer4}, #{answer5}, #{introduce})
	</insert>
	
	<!-- 닉네임 중복체크 -->
	<select id = "nickCheck" parameterType = "map" resultType = "map">
		SELECT GROUPNICKNAME
		FROM GGROUPMEMBER
		WHERE GROUPNICKNAME = #{nickname} AND GROUPKEY = #{groupKey}
	</select>
	
	<select id="groupinfo" resultType="group" parameterType="int">
		select *
		from ggroup where groupkey =#{groupkey}
	</select>

	<update id="groupMainImgUpdate" parameterType="group">
		update ggroup set
		groupidorigin=#{groupIdOrigin}, groupdfile=#{groupDFile} where
		groupkey=#{groupKey}
	</update>

	<update id="groupImgUpdate" parameterType="group">
		update ggroup set
		groupcorigin=#{groupCOrigin}, groupcfile=#{groupCFile} where
		groupkey=#{groupKey}
	</update>

	<select id="groupwhere" resultType="location"
		parameterType="int">
		select * from glocation where locationkey =#{wherekey}
	</select>

	<select id="groupage" resultType="int" parameterType="int">
		select
		agevalue from gage where agekey =#{agekey}
	</select>

	<select id="groupdcategory" resultType="String"
		parameterType="int">
		select dcategoryname from gcategory where dcategorykey
		=#{categorykey}
	</select>

	<select id="groupscategory" resultType="String"
		parameterType="int">
		select scategoryname from gcategory2 where dcategorykey
		=#{categorykey}
	</select>

	<select id="groupmembers" resultType="int" parameterType="int">
		select
		count(*) from ggroupmember where usergrade in(0,1) and groupkey
		=#{groupkey}
	</select>

	<select id="groupmaster" resultType="String" parameterType="int">
		select groupnickname from ggroupmember where userkey = (select userkey
		from ggroup where groupkey =#{groupkey})
	</select>

	<select id="groupboardlist" resultType="groupBoard"
		parameterType="int">
		select * from ggroupboard where groupkey =
		#{groupkey}
		order by boardseq
	</select>

	<select id="groupmemberlist" resultType="memberlist"
		parameterType="int">
		select userimagefile, groupnickname from gusers left
		join GGROUPMEMBER
		using(userkey) where groupkey=#{groupkey} and
		usergrade in(0,1)
	</select>

	<select id="groupmeetinglist" resultType="post"
		parameterType="int">
		select rownum, A.* from(select
		postkey,posttitle,postdate,userkey,groupkey,boardkey,to_char(cstartdate,'YYYY-MM-DD
		HH24:MI') cstartdate,cenddate,cmoney,maxperson,location,currentperson
		from post left join calendar
		using(postkey) left join (select count(*)
		currentperson,postkey from calendarmember left join
		(select * from post left join ggroupboard using(boardkey) where
		boardtype='N')
		using (postkey) left join calendar using (postkey) group by postkey) using
		(postkey)
		where groupkey=1 order by
		cstartdate) A
	</select>

	<select id="groupcalendarlist" resultType="memberlist"
		parameterType="java.util.Map">
		select userimagefile, groupnickname from gusers left
		join GGROUPMEMBER using(userkey) left join calendarmember a
		using(userkey) where a.groupkey=#{groupkey} and a.postkey=#{postkey}
	</select>
</mapper>